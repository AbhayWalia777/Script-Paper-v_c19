var myInterval,myInterval2,websocket,marketDepthInterval,sqModal,addQtyModal,allowedTradingUnit,SocketInterval,_WatchlistCurrentTabIndex=0,_WatchListLength=0,Completedpageno=0,LastPriceDictionary=[],BtnIds=[],_WatchlistTotalPageNo=0,_WatchlistCurrentPageNo=1,_WatchlistPreviousTotalPageNo=0,_isWatchlistCallBack=!1,allObj=[],_CompletedTotalPageNo=0,_CompletedPreviousTotalPageNo=0,_CompletedCurrentPageNo=1,_CompletedCallBack=!1,_ActiveTotalPageNo=0,_ActivePreviousTotalPageNo=0,_ActiveCurrentPageNo=1,_ActiveCallBack=!1,LevelLoginUser=0,Current_Loop_Valueof_Watchlist=0;function initSocket(){$.ajax({url:"/Home/ConnectWebSocket",type:"GET",dataType:"json",success:function(e){if("undefined"!=e){var t=JSON.parse(e);t.hasOwnProperty("Table")&&(allObj=t.Table,wt())}}})}function wt(){var e=allObj;if(null!=e&&"undefined"!=e&&e.length>0)for(var t=document.getElementById("watchlistDiv"),a=0;a<t.children.length;){var i=t.children[a].id,r=t.children[a].dataset.Scripttype;if(void 0!=i&&""!=i){var l=e.filter(e=>e.InstrumentToken==$("#"+i).find("input[Name=hiddenCode]").val());if(l.length>0){var o=l[0],s=0,n=0,d=0,c="",p="",T="";for(var v in LastPriceDictionary)if(LastPriceDictionary[v].key==o.InstrumentToken){s=parseFloat(LastPriceDictionary[v].value),n=parseFloat(LastPriceDictionary[v].Bid),d=parseFloat(LastPriceDictionary[v].Ask),c=LastPriceDictionary[v].LTPColor,p=LastPriceDictionary[v].AskColor,T=LastPriceDictionary[v].BidColor;break}var u="";parseFloat(o.Ask)>d&&(u='<div class="price-up">'+o.Ask.toFixed(2)+"</div>",p="price-up"),parseFloat(o.Ask)<d&&(u='<div class="price-down">'+o.Ask.toFixed(2)+"</div>",p="price-down"),o.Ask==d&&(""==p&&(p="price-up"),u='<div class="'+p+'">'+o.Ask.toFixed(2)+"</div>");var b="";parseFloat(o.Bid)>n&&(b='<div class="price-up">'+o.Bid.toFixed(2)+"</div>",T="price-up"),parseFloat(o.Bid)<n&&(b='<div class="price-down">'+o.Bid.toFixed(2)+"</div>",T="price-down"),o.Bid==n&&(""==T&&(T="price-up"),b='<div class="'+T+'">'+o.Bid.toFixed(2)+"</div>"),null==o.Close&&(o.Close=0);var g=parseFloat(o.Lastprice)-parseFloat(o.Close),h="",m="";g<0?(m=parseFloat(g)/parseFloat(o.Close)*100,"BINANCE"==r&&(m=o.Change),"FOREX"==r&&(m=0),h='<i class="fa fa-angle-down percentage-price-down">&nbsp&nbsp'+m.toFixed(2)+"</i>"):g>=0&&(m=parseFloat(g)/parseFloat(o.Close)*100,"BINANCE"==r&&(m=o.Change),"FOREX"==r&&(m=0),h='<i class="fa fa-angle-up percentage-price-up">&nbsp&nbsp'+m.toFixed(2)+"</i>");var y="";if(parseFloat(o.Lastprice)>s&&(y='LTP : <span class="price-up">'+o.Lastprice.toFixed(2)+"</span>",c="price-up"),parseFloat(o.Lastprice)<s&&(y='LTP : <span class="price-down">'+o.Lastprice.toFixed(2)+"</span>",c="price-down"),o.Lastprice==s&&(""==c&&(c="price-up"),y='LTP : <span class="'+c+'">'+o.Lastprice.toFixed(2)+"</span>"),$("#buySellModel #lblScriptCode").text()==o.ScriptCode){var f=o.Lastprice.toString();$("#buySellModel #lblLastPrice").text(f),$("#buySellModel #lblLastBid").text(o.Bid),$("#buySellModel #lblLastAsk").text(o.Ask),$("#buySellModel #hdnPrice").val(f)}var S=!1;for(var v in LastPriceDictionary)if(LastPriceDictionary[v].key==o.InstrumentToken){S=!0,LastPriceDictionary[v].value=o.Lastprice,LastPriceDictionary[v].Bid=o.Bid,LastPriceDictionary[v].Ask=o.Ask,LastPriceDictionary[v].LTPColor=c,LastPriceDictionary[v].AskColor=p,LastPriceDictionary[v].BidColor=T;break}S||LastPriceDictionary.push({key:o.InstrumentToken,value:o.Lastprice,Bid:o.Bid,Ask:o.Ask,LTPColor:c,AskColor:p,BidColor:T})}}if($("#buySellModel").hasClass("in")){var l=e.filter(e=>e.InstrumentToken==$("#buySellModel #lblScriptCode").text());l.length>0&&($("#buySellModel #lblLastPrice").text(l[0].Lastprice),$("#buySellModel #lblLastBid").text(l[0].Bid),$("#buySellModel #lblLastAsk").text(l[0].Ask),$("#buySellModel #hdnHigh").text(l[0].high),$("#buySellModel #hdnLow").text(l[0].low),$("#buySellModel #hdnPrice").val(l[0].Lastprice))}if("block"==$(".mobile-context-menu").css("display")){var l=e.filter(e=>e.InstrumentToken==clicked_Watchlist_InstrumentToken);l.length>0&&$("#lastPriceMobileContextMenu").html("LTP : "+l[0].Lastprice)}a++}}function MarketDepthPop(e,t,a){$.ajax({url:"/Trade/_MarketDepthMobile",type:"POST",data:{ScriptCode:e},success:function(i){return $("#marketDepthDiv").html(i),marketDepthInterval=setInterval(function(){SetMarketDepthForRefresh(e,t,a)},1e3),!0}})}function SetActiveTradeDetails(e,t){var a,i="'"+e.TradeSymbol+"'",r="'"+e.ScriptInstrumentType+"'",l="'"+e.ProductType+"'",o="'"+e.PriceType+"'",s="'"+e.CurrentPosition.toString()+"'",n="'"+e.Status.toString()+"'",d="'"+e.ObjScriptDTO.ScriptExchange.toString()+"'",c="",p="",T=!1;"Manual"==e.Strategyname&&(T=!0),$("#Role_Id").val();var v=e.CurrentPosition,u=2;a=1==e.TRADING_UNIT_TYPE?e.Qty/e.ObjScriptDTO.ScriptLotSize:e.ObjScriptDTO.ScriptLotSize>10&&"MCX"==e.ObjScriptDTO.ScriptExchange&&("EXPO"==e.COMPANY_INITIAL&&51==e.TENANT_ID||"ASR"==e.COMPANY_INITIAL&&57==e.TENANT_ID||"RVERMA"==e.COMPANY_INITIAL)?e.Qty/(e.ObjScriptDTO.ScriptLotSize/10):e.Qty;var b="Qty"==e.TRADING_UNIT.toLowerCase()?"U":"",g="",h="";"REJECTED"!=e.Status.toUpperCase()&&("Buy"==e.CurrentPositionNew&&(u=1),g=' <button class="btn btn-primary btn-sm btn-Edit" id="btn-Edit'+e.ActiveTradeID+'" onclick="buySellPopUp('+e.BuyQtyWiseOrLot+","+e.ScriptCode+","+u+","+i+","+e.WID+","+e.OrderPrice+","+r+","+d+","+a+","+e.ObjScriptDTO.ScriptLotSize+","+e.TriggerPrice+","+e.SLNew+","+e.TGNew+","+o+","+l+","+e.ActiveTradeID+","+n+')" type="button"><i class="fa fa-pencil"></i></button> ',c=' <button class="btn btn-primary btn-sm btn-Sqroff" id="btn-Sqroff'+e.ActiveTradeID+'" onclick="SquareOff('+e.ActiveTradeID+","+s+","+n+","+a+","+T+')" type="button">Sqr Off</button> ',p=' <button class="btn btn-danger btn-sm btn-Sell btn-Sqroff" id="btn-Sqroff'+e.ActiveTradeID+'" onclick="SquareOff('+e.ActiveTradeID+","+s+","+n+","+a+","+T+')" type="button">Sqr Off</button> ',"OPEN"!=e.Status.toUpperCase()&&T&&(h='<button class="btn btn-primary btn-sm btn-Sell btn-Add" id="btn-Add'+e.ActiveTradeID+'" onclick="AddQty('+e.ActiveTradeID+","+s+","+n+')" type="button"><i class="fa fa-plus"></i></button>')),"Buy"==e.CurrentPositionNew?v=p:"Sell"==e.CurrentPositionNew&&(v=c);var m="";("REJECTED"==e.Status.toUpperCase()||"CANCELED"==e.Status.toUpperCase())&&(m='<button id="btn-DelActive'+e.ActiveTradeID+'" onclick = "DeleteRejectedTrade('+e.ActiveTradeID+')" type = "button" class="btn btn-warning btn-sm btn-DelActive" > <i class="fa fa-trash-o"></i></button > ');var y=$("#Role_Id").val();(4==y||5==y)&&"CANCELED"!=e.Status&&"REJECTED"!=e.Status&&(m='<button class="btn btn-primary btn-sm btn-Sell btn-DelActive" href="javascript:void(0)" id="btn-DelActive'+e.ActiveTradeID+'" onclick="DeleteActiveTrade('+e.ActiveTradeID+","+e.UserID+')" data-bind='+e.ActiveTradeID+' style="margin-right:10px;margin-left:5px;" ><i class="fa fa-trash-o"></i> </button> '),e.ActiveTradeID,e.ActiveTradeID;var f=v+g+""+h+m,S=$("#Companyinitials").val();"FOREX"==e.ObjScriptDTO.ScriptExchange&&"RT"==S&&(e.ObjScriptDTO.Lastprice=e.ObjScriptDTO.Lastprice.toFixed(5),e.OrderPrice=e.OrderPrice.toFixed(5),e.TriggerPrice=e.TriggerPrice.toFixed(5),e.SL=e.SL.toFixed(5),e.TGT2=e.TGT2.toFixed(5),e.TGT3=e.TGT3.toFixed(5),e.TGT4=e.TGT4.toFixed(5));var P="";parseFloat(e.Profitorloss)>=0?P='<font style="color:#4987ee !important;font-weight:bold;">'+e.Profitorloss+"</font>":0>parseFloat(e.Profitorloss)&&(P='<font style="color:#ff4a4a;font-weight:bold;">'+e.Profitorloss+"</font>");var x="";e.Email=e.Email.split("@")[0],x=0==e.SL&&0==e.TGT2&&0==e.TGT3&&e.TriggerPrice<.1&&"COMPLETE"==e.Status||"OPEN"==e.Status?'<div class="col-12" >   <p class="watchlist-p" style="display:none;font-size: 11px;  margin-bottom: 5px;"> SL : '+e.SL+" | TGT : "+e.TGT2+" | TGT2 : "+e.TGT3+" | TGT3 : "+e.TGT4+'</p>   <p class="watchlist-p" style="display:none;font-size: 11px;  margin-bottom: 5px;"> TRIGGER : '+e.TriggerPrice+" |  Status : "+e.Status+'</p>   <p class="watchlist-p" style="font-size: 11px;  margin-bottom: 5px;">Date : '+e.OrderDate+" "+e.OrderTime+" | Name: "+e.Email+" | CP: "+e.CurrentPositionNew+" </p></div>":'<div class="col-12" >   <p class="watchlist-p" style="font-size: 11px;  margin-bottom: 5px;"> SL : '+e.SL+" | TGT : "+e.TGT2+" | TGT2 : "+e.TGT3+" | TGT3 : "+e.TGT4+'</p>   <p class="watchlist-p" style="font-size: 11px;  margin-bottom: 5px;"> TRIGGER : '+e.TriggerPrice+" |  Status : "+e.Status+'</p>   <p class="watchlist-p" style="font-size: 11px;  margin-bottom: 5px;">Date : '+e.OrderDate+" "+e.OrderTime+" | Name: "+e.Email+" | CP: "+e.CurrentPositionNew+" </p></div>";var L='<div class="row p-2 activeTradeRow" id="'+e.OrderDate+"_"+e.OrderTime+'" data-scripttradingsymbol="'+e.TradeSymbol+'" data-ScriptExchange="'+e.ObjScriptDTO.ScriptExchange+'" data-PL="'+e.Profitorloss+'" data-Qty="'+a+'"><div class="col-12" ><div class="row-New-Theme p-2 watchlistRow"><div class="card-body" style="padding:5px;">   <div class="row"><div class="col-6"> <p class="watchlist-p" style="font-size: 14px; margin-bottom: 5px;">'+e.TradeSymbol+'</p></div><div class="col-6">     <div class="row" style="margin-top:3px;">          <div class="col-5">               <label class="watchlist-p" style="font-size: 12px">'+a+b+'</label>          </div>             <div class="col-7" style="margin-left:-7px;">                  <span class="watchlist-p" style="font-size: 12px;font-weight:bold"> LTP:                '+e.ObjScriptDTO.Lastprice+'                        </span>                 </div>              </div>           </div><div style="display:none;">'+f+'</div><div class="col-5">  <p class="watchlist-p" style="font-size: 13px;  margin-bottom: 7px;margin-top:7px;">AVG : '+e.OrderPrice+' </p></div><div class="col-5">  <p class="watchlist-p" style="font-size: 13px;  margin-bottom: 7px;margin-top:7px;"> P&L : '+P+" </p></div>"+x+"        </div>     </div>  </div></div ></div >";$("#"+t).append(L)}function SetCompletedTradeDetails(e){"TGT2"==e.Status?e.Status="TARGET":"TGT3"==e.Status?e.Status="TARGET2":"TGT4"==e.Status?e.Status="TARGET3":"SL"==e.Status&&(e.Status="STOPLOSS"),e.Completedtradeid,e.Completedtradeid,e.Completedtradeid,t=1==e.TRADING_UNIT_TYPE?e.Qty/e.ScriptLotSize:e.ScriptLotSize>10&&"MCX"==e.ScriptExchange&&("EXPO"==e.COMPANY_INITIAL&&51==e.TENANT_ID||"ASR"==e.COMPANY_INITIAL&&57==e.TENANT_ID||"RVERMA"==e.COMPANY_INITIAL)?e.Qty/(e.ScriptLotSize/10):e.Qty;var t,a="Qty"==e.TRADING_UNIT.toLowerCase()?"U":"";"FOREX"==e.Scripttype&&"RT"==$("#CompanyInitial").val()&&(e.Entryprice=e.Entryprice.toFixed(5),e.Exitprice=e.Exitprice.toFixed(5),e.ObjScriptDTO.Lastprice=e.ObjScriptDTO.Lastprice.toFixed(5),e.Profitorloss=e.Profitorloss.toFixed(5),e.Netprofitorloss=e.Netprofitorloss.toFixed(5)),$("#tblCompletedTradeList").DataTable().row.add([e.Completedtradeid,e.TradeSymbol,t+a,e.CurrentPosition,e.Entrytime,e.Entryprice,e.Exittime,e.Exitprice,e.Profitorloss,e.Brokerage,e.Netprofitorloss,e.Status,e.ProductType,e.IsLive,e.Strategyname,e.Watchlistname,e.Publishname,e.Fundmanagername]).order([0,"desc"]).draw();for(var i=document.getElementById("tblCompletedTradeList"),r=0;r<i.rows.length;r++){var l=$(i.rows[r].cells[11]).text();("TARGET"==l||"TARGET2"==l||"TARGET3"==l)&&($(i.rows[r].cells[11]).css("background-color","#14a964"),$(i.rows[r].cells[11]).css("color","white")),"STOPLOSS"==l&&($(i.rows[r].cells[11]).css("background-color","#d83824"),$(i.rows[r].cells[11]).css("color","white"))}}function SetWatchTradeDetails(e){e.Ask.toFixed(2),e.Bid.toFixed(2);var t=' LTP <span class="price-up" >'+e.Lastprice.toFixed(2)+"</span>",a=e.ScriptName.replace(/'/g,"");a="'"+a+"'";var i=e.ScriptTradingSymbol.replace(/'/g,"");i="'"+i+"'";var r="'"+e.ScriptInstrumentType+"'",l="'"+e.ScriptExchange.toString()+"'",o=parseFloat(e.Lastprice)-parseFloat(e.close),s="",n="",d="";o<0?(n=parseFloat(o)/parseFloat(e.close)*100,"BINANCE"==e.Scripttype&&(n=e.PerChange),"FOREX"==e.Scripttype&&(n=0),s='<i class="fa fa-angle-down percentage-price-down">&nbsp&nbsp'+n.toFixed(2)+"</i>",d='<i class="fa percentage-price-down">&nbsp&nbsp'+o.toFixed(2)+"</i>"):o>=0&&(n=parseFloat(o)/parseFloat(e.close)*100,"BINANCE"==e.Scripttype&&(n=e.PerChange),"FOREX"==e.Scripttype&&(n=0),s='<i class="fa fa-angle-up percentage-price-up">&nbsp&nbsp'+n.toFixed(2)+"</i>",d='<i class="fa percentage-price-up">&nbsp&nbsp'+o.toFixed(2)+"</i>");var c='<input Name="hiddenCode" value="'+e.ScriptCode+'" type="hidden" >',p="btnBuy"+e.ScriptCode,T="btnSell"+e.ScriptCode,v="btnMarketDepth"+e.ScriptCode,u=' <button id="btnDelete'+e.ScriptCode+'" onclick="removeScript('+e.ScriptCode+","+e.WID+')" type="button" class="btn btn-warning btn-sm btn-delete"><i class="fa fa-trash-o"></i></button> ',b='<div tabindex="-1" style="display:none;" class="b-btn"><button class="btn-Buy" id="'+p+'" onclick="buySellPopUp(0,'+e.ScriptCode+",1,"+a+","+e.WID+","+e.Lastprice+","+r+","+l+",1,"+e.ScriptLotSize+","+e.Lastprice+')" type="button" class="btn btn-success btn-sm btn-Buy">B </button> ',g='<button class="btn-Sell" id="'+T+'" onclick="buySellPopUp(0,'+e.ScriptCode+",2,"+a+","+e.WID+","+e.Lastprice+","+r+","+l+",1,"+e.ScriptLotSize+","+e.Lastprice+')" type="button" class="btn btn-danger btn-sm btn-Sell"> S </button> ',h=$("#CompanyInitial").val();"FOREX"==e.Scripttype&&"RT"==h&&(e.open=e.open.toFixed(5),e.Lastprice=e.Lastprice.toFixed(5),e.high=e.high.toFixed(5),e.low=e.low.toFixed(5),e.close=e.close.toFixed(5));var m="",y="";""!=e.Scriptexpiry&&(y='<span style="color: red;font-size: 13px;">'+e.Scriptexpiry.split(" ")[0]+"</span>");var f="";"FUT"==e.ScriptInstrumentType||("PE"==e.ScriptInstrumentType||"CE"==e.ScriptInstrumentType)&&(f=e.ScriptInstrumentType),""==e.ScriptName&&(e.ScriptName=e.ScriptTradingSymbol),e.ScriptName.length>18&&(e.ScriptName=e.ScriptName.substring(0,18)+"..."),m='<div class="row watchlistRowViewNEWUI" style="border-bottom: 1px solid #ddd;" id="'+e.ScriptCode+'" data-Scripttype="'+e.Scripttype+'"  data-scripttradingsymbol="'+e.ScriptTradingSymbol+'" data-ScriptExchange="'+e.ScriptExchange+'"><div class="col-12" >'+(b+g+u)+"</div>"+c+' <div class="watchlist-card c-left-border watchlist-table"><div class="card-body" id="'+v+'" style="padding:5px;">   <div class="row"><div class="col-6">  <p class="watchlist-p watchlist-text-BBR Percentage_SEGMENT">  '+d+"("+s+')</p></div><div class="col-5">  <p class="watchlist-p watchlist-text-BBR LTP_SEGMENT" style="margin-left:-13px;float:left;padding-left: 4px;">  '+t+'</p></div><div class="col-6"> <p class="watchlist-p watchlist-text-BBR">'+e.ScriptName+f+'</p></div><div class="col-5">     <div class="row Bid_Ask_SEGMENT" style="margin-left:2px;">             <div class="col-5" style="margin-left:-15px;display: flex;font-size: 20px !important;">               <div class="price-up" style="padding-bottom:0px;">'+e.Bid.toFixed(2)+'</div>             </div>            <div class="col-7" style="display:flex;margin-left:15px;font-size: 20px !important;">              <div class="price-up" style="padding-bottom:0px;">'+e.Ask.toFixed(2)+'</div>       </div>               </div>           </div><div class="col-4">  <p class="watchlist-p watchlist-text-BBR">'+y+'</p></div><div class="col-7">  <p class="watchlist-p watchlist-text-BBR HIGH_LOW" style="float: left;padding-left: 57px;"> H : '+e.high+" |   L : "+e.low+"</p></div>        </div>     </div>  </div></div ></div >",$("#watchlistDiv").append(m)}$(document).keydown(function(e){if(9==e.keyCode)$("#buySellModel").hasClass("in")||$("#MarketDepthModal").hasClass("in")||($("td").removeClass("hover"),_WatchlistCurrentTabIndex<_WatchListLength?$("#tblWatchListTradeListBody > tr:nth-child("+(_WatchlistCurrentTabIndex+=1)+") > td:nth-child(1)").addClass("hover"):$("#tblWatchListTradeListBody > tr:nth-child("+(_WatchlistCurrentTabIndex=1)+") > td:nth-child(1)").addClass("hover"));else if(40==e.keyCode)$("#buySellModel").hasClass("in")||$("#MarketDepthModal").hasClass("in")||($("td").removeClass("hover"),e.preventDefault(),_WatchlistCurrentTabIndex<_WatchListLength?$("#tblWatchListTradeListBody > tr:nth-child("+(_WatchlistCurrentTabIndex+=1)+") > td:nth-child(1)").addClass("hover"):$("#tblWatchListTradeListBody > tr:nth-child("+(_WatchlistCurrentTabIndex=1)+") > td:nth-child(1)").addClass("hover"));else if(38==e.keyCode)$("#buySellModel").hasClass("in")||$("#MarketDepthModal").hasClass("in")?$("#price").is(":focus")||$("#txtStopLoss").is(":focus")||$("#txtTarget").is(":focus")||!document.getElementById("rbtnLimit").checked?$("#TriggerPrice").is(":focus")||$("#txtTarget").is(":focus")||$("#txtStopLoss").is(":focus")||!document.getElementById("rbtnSL").checked&&!document.getElementById("rbtnSLM").checked||(e.preventDefault(),$("#TriggerPrice").focus()):(e.preventDefault(),$("#price").focus()):(e.preventDefault(),_WatchlistCurrentTabIndex>1?($("td").removeClass("hover"),$("#tblWatchListTradeListBody > tr:nth-child("+(_WatchlistCurrentTabIndex-=1)+") > td:nth-child(1)").addClass("hover")):($("td").removeClass("hover"),$("#tblWatchListTradeListBody > tr:nth-child("+(_WatchlistCurrentTabIndex=_WatchListLength)+") > td:nth-child(1)").addClass("hover")));else if(112==e.keyCode){if(e.preventDefault(),_WatchlistCurrentTabIndex>0){var t=BtnIds[_WatchlistCurrentTabIndex-1].BuyBtnId;$("#"+t).trigger("click"),$("#MarketDepthModal").modal("hide"),$("#CompletedTradeModal").modal("hide")}}else if(113==e.keyCode){if(e.preventDefault(),_WatchlistCurrentTabIndex>0){var t=BtnIds[_WatchlistCurrentTabIndex-1].SellBtnId;$("#"+t).trigger("click"),$("#MarketDepthModal").modal("hide"),$("#CompletedTradeModal").modal("hide")}}else if(46==e.keyCode){if(_WatchlistCurrentTabIndex>0){e.preventDefault();var t=BtnIds[_WatchlistCurrentTabIndex-1].DeleteBtnId;$("#"+t).trigger("click")}}else if(114==e.keyCode)e.preventDefault(),$("html, body").animate({scrollTop:$("#tblActiveTradeList").offset().top},2e3);else if(115==e.keyCode)e.preventDefault(),$("#btnMoreInfoCompletedTrade2").trigger("click"),$("#buySellModel").modal("hide"),$("#MarketDepthModal").modal("hide");else if(116==e.keyCode){if(e.preventDefault(),_WatchlistCurrentTabIndex>0){var t=BtnIds[_WatchlistCurrentTabIndex-1].MarketDepthBtnId;$("#"+t).trigger("click"),$("#buySellModel").modal("hide"),$("#CompletedTradeModal").modal("hide")}}else 27==e.keyCode&&(e.preventDefault(),$("#buySellModel").modal("hide"),$("#CompletedTradeModal").modal("hide"),$("#MarketDepthModal").modal("hide"))}),$(document).ready(function(){initSocket(),SocketInterval=setInterval(function(){initSocket()},1e3),LevelLoginUser=$("#LevelLoginUser").text(),SetTradeData(),$("#tblActiveTradeList").DataTable({paging:!1,lengthChange:!1,info:!1}),$("#tblOpenTradeList").DataTable({paging:!1,lengthChange:!1,info:!1}),$("#tblCompletedTradeList").DataTable({paging:!1,lengthChange:!1,order:[[5,0,"desc"]],info:!1}),$("#tblWatchListTradeList").DataTable({paging:!1,lengthChange:!1,processing:!0,info:!0,ordering:!1,searching:!1}),myInterval2=setInterval(function(){SetWalletBalance()},1e3),$("input[Name=MarketType]").on("click",function(e){var t=$(e.currentTarget).val(),a=$("#hdnPrice").val(),i=$("#hdnPrice").val();$("#txtTarget").removeAttr("disabled"),$("#txtTarget").removeAttr("readonly"),$("#txtStopLoss").removeAttr("disabled"),$("#txtStopLoss").removeAttr("readonly"),"Limit"==t?($("#buySellModel #price").removeAttr("disabled"),$("#buySellModel #price").removeAttr("readonly"),$("#buySellModel #price").val(a),$("#buySellModel #TriggerPrice").val("0"),$("#buySellModel #TriggerPrice").attr("disabled","disabled")):"SL"==t?($("#buySellModel #price").removeAttr("disabled"),$("#buySellModel #price").removeAttr("readonly"),$("#buySellModel #price").val(a),$("#buySellModel #TriggerPrice").val(i),$("#buySellModel #TriggerPrice").removeAttr("disabled"),$("#buySellModel #TriggerPrice").removeAttr("readonly")):"SL-M"==t?($("#buySellModel #TriggerPrice").removeAttr("disabled"),$("#buySellModel #TriggerPrice").removeAttr("readonly"),$("#buySellModel #TriggerPrice").val(i),$("#buySellModel #price").val("0"),$("#buySellModel #price").attr("disabled","disabled"),$("#txtTarget").attr("disabled","disabled"),$("#txtTarget").attr("readonly","readonly"),$("#txtStopLoss").attr("disabled","disabled"),$("#txtStopLoss").attr("readonly","readonly")):"MARKET"==t&&($("#buySellModel #price").val("0"),$("#buySellModel #price").attr("disabled","disabled"),$("#buySellModel #price").attr("readonly","readonly"),$("#buySellModel #TriggerPrice").val("0"),$("#buySellModel #TriggerPrice").attr("disabled","disabled"),$("#buySellModel #TriggerPrice").attr("readonly","readonly"))}),$(".mobileBuyBtn").on("click",function(){$("#"+mobilebuyBtn).trigger("click"),$(".mobile-context-menu").css("display","none")}),$(".mobileSellBtn").on("click",function(){$("#"+mobilesellBtn).trigger("click"),$(".mobile-context-menu").css("display","none")}),$(".mobileDeleteBtn").on("click",function(){$("#"+mobiledeleteBtn).trigger("click"),$(".mobile-context-menu").css("display","none")}),$(".mobileSqrBtn").on("click",function(){sqModal=$("#sqOfModal"),$("#"+mobileSqrBtn).trigger("click"),$(".mobile-context-menu-Active").css("display","none")}),$(".mobileAddBtn").on("click",function(){addQtyModal=$("#addQtyModal"),$("#"+mobileAddBtn).trigger("click"),$(".mobile-context-menu-Active").css("display","none")}),$(".mobileEditBtn").on("click",function(){$("#"+mobileEditBtn).trigger("click"),$(".mobile-context-menu-Active").css("display","none")}),$(".mobileDeleteActiveBtn").on("click",function(){$("#"+mobileDeleteActiveBtn).trigger("click"),$(".mobile-context-menu-Active").css("display","none")}),$("#watchlistDiv").delegate(".watchlistRowViewNEWUI","click",function(){if(screen.width<=768){window.clearInterval(marketDepthInterval),clicked_Watchlist_InstrumentToken=$(this).attr("id"),$("#marketDepthDiv").html(""),$("#marketDepthDiv").append('<photo class="shine-watchlist"></photo><photo class= "shine-watchlist"></photo>'),clicked_Watchlist_ScriptExchange=$(this).attr("data-ScriptExchange"),$("#scriptTradingSymbolMobileContextMenu").html($(this).attr("data-scripttradingsymbol")+' <span style="font-size:12px;"> ('+clicked_Watchlist_ScriptExchange+")</span>");var e=allObj.filter(e=>e.InstrumentToken==clicked_Watchlist_InstrumentToken);e.length>0&&$("#lastPriceMobileContextMenu").html("LTP : "+e[0].Lastprice),mobilebuyBtn=$($(this).find(".btn-Buy")).find(".btn-Buy").prevObject[0].id,mobilesellBtn=$($(this).find(".btn-Sell")).find(".btn-Sell").prevObject[0].id,mobiledeleteBtn=$($(this).find(".btn-delete")).find(".btn-delete").prevObject[0].id,$(".mobile-context-menu").css("display","block"),""!=clicked_Watchlist_InstrumentToken&&MarketDepthPop(clicked_Watchlist_InstrumentToken,$(this).attr("data-scripttradingsymbol"),0)}}),$("#ActiveTradeDiv").delegate(".activeTradeRow","click",function(){screen.width<=768&&(clicked_Watchlist_InstrumentToken=$(this).attr("id"),clicked_Watchlist_ScriptExchange=$(this).attr("data-ScriptExchange"),$("#scriptTradingSymbolMobileContextMenuActive").html($(this).attr("data-scripttradingsymbol")+' <span style="font-size:12px;"> ('+clicked_Watchlist_ScriptExchange+")</span>"),$("#lastPriceMobileContextMenuActive").html(clicked_Watchlist_InstrumentToken),$("#QtyMobileContextMenuActive").html("Qty: "+$(this).attr("data-Qty")),$("#ProfitLossContextMenuActive").html("PL: "+$(this).attr("data-PL")),mobileSqrBtn=$($(this).find(".btn-Sqroff")).find(".btn-Sqroff").prevObject[0].id,mobileAddBtn=$($(this).find(".btn-Add")).find(".btn-Add").prevObject[0].id,mobileEditBtn=$($(this).find(".btn-Edit")).find(".btn-Edit").prevObject[0].id,mobileDeleteActiveBtn=$($(this).find(".btn-DelActive")).find(".btn-DelActive").prevObject[0].id,$(".mobile-context-menu-Active").css("display","block"))}),$(document).on("click",".completedTradeRow",function(){var e=$(this).attr("data-id"),t=$(this).attr("data-ScriptName");$.ajax({url:"/Trade/SetMobileReportDetailData",type:"POST",data:{Completedtradeid:e,scriptTradingSymbol:t},success:function(e){return $("#MarketDepthModal .modal-body").html(e),$("#MarketDepthModal").modal({backdrop:!1,show:!0}),$("body").removeClass("modal-open"),!1}})})}),document.body.addEventListener("click",function(e){var t=document.querySelector("ul.mobile-context-menu-list.list-flat"),a=document.querySelector("#watchlistDiv"),i=document.querySelector("#ActiveTradeDiv"),r=document.querySelector("ul.mobile-context-menu-Active-list.list-flat");""==t||null==t||t.contains(e.target)||a.contains(e.target)||(window.clearInterval(marketDepthInterval),$(".mobile-context-menu").css("display","none")),""==i||null==i||i.contains(e.target)||r.contains(e.target)||$(".mobile-context-menu-Active").css("display","none")});var pageno=0;function removeScript(e,t){newconfirmMobile("Delete This Record",function(){var a=$("body").find(".cresp").html();$("body").find(".cresp").remove(),"Yes"==a&&e>0&&t>0&&$.ajax({url:"/Watchlist/DeleteScript",type:"POST",data:{intWID:t,ScriptCode:e},dataType:"json",traditional:!0,success:function(t){return JSON.parse(t).IsError?(toastr.error("Can Not Delete This Record.There Is One Active Trade."),!1):($("#tblList").DataTable().row($("#btnName"+e).parents("tr")).remove().draw(!1),toastr.success("Script Deleted Successfully."),!1)}})})}function SetWalletBalance(){$.ajax({url:"/Admin/GetBalance",type:"GET",dataType:"json",async:!0,success:function(e){$("#WalletBalance").text(e)}})}function SetTradeData(){try{var e="";e=!0==$("#rdAll").prop("checked")?{tradetype:0}:!0==$("#rdLive").prop("checked")?{tradetype:1}:{tradetype:2},$.ajax({url:"/Trade/GetDataManageTransaction",type:"GET",data:e,dataType:"json",traditional:!0,success:function(e){SetResult(e),myInterval=setInterval(function(){SetTradeDataForRefresh()},1e3)}})}catch(t){toastr.error("Error On SetTradeData.")}}function SetTradeDataForRefresh(){try{var e=$("#watchlistHiddenId").val(),t=$("#cboScriptExchange option:selected").val();if("--Select--"!=$("#UserIds option:selected").text())var a=$("#UserIds").val(),i="0";if((1==LevelLoginUser||2==LevelLoginUser)&&"--Select--"!=$("#AdminIds option:selected").text())var a=$("#AdminIds").val(),i="1";if((1==LevelLoginUser||2==LevelLoginUser||3==LevelLoginUser)&&"--Select--"!=$("#BrokerIds option:selected").text())var a=$("#BrokerIds").val(),i="1";if(4==LevelLoginUser&&"--Select--"!=$("#UserIds option:selected").text())var a=$("#UserIds").val(),i="1";var r="";r=!0==$("#rdAll").prop("checked")?{tradetype:0,WID:e,scriptExchangeType:t,WatchListPage:_WatchlistCurrentPageNo,CompletedListPage:_CompletedCurrentPageNo,ActiveTradePage:_ActiveCurrentPageNo,UserID:a,IsAdmin:i,searchedData:$("#searchText").val()}:!0==$("#rdLive").prop("checked")?{tradetype:1,WID:e,scriptExchangeType:t,WatchListPage:_WatchlistCurrentPageNo,CompletedListPage:_CompletedCurrentPageNo,ActiveTradePage:_ActiveCurrentPageNo,UserID:a,IsAdmin:i,searchedData:$("#searchText").val()}:{tradetype:2,WID:e,scriptExchangeType:t,WatchListPage:_WatchlistCurrentPageNo,CompletedListPage:_CompletedCurrentPageNo,ActiveTradePage:_ActiveCurrentPageNo,UserID:a,IsAdmin:i,searchedData:$("#searchText").val()},$.ajax({url:"/Trade/GetDataManageTransaction",type:"GET",data:r,dataType:"json",async:!0,success:function(e){SetResult(e)}})}catch(l){toastr.error("Error On SetTradeData.")}}function SetResult(e){var t=0,a=0,i=JSON.parse(e);if(null!=i){if(i.TotalCompletedTradeCount>0?$(".TotalCompletedTrade > h3").text(i.TotalCompletedTradeCount):$(".TotalCompletedTrade > h3").text("0"),$(".TotalCompletedTradeProfitOrLoss > h3").text(i.TotalCompletedTradeProfitOrLoss),$("#watchlistDiv").html(""),null!=i.objLstWatchList){for(var r=0;r<i.objLstWatchList.length;r++){var l=i.objLstWatchList[r];SetWatchTradeDetails(l)}0==i.objLstWatchList.length&&$("#watchlistDiv").html("")}if(null!=i.ActiveTrade){if(i.ActiveTrade.length>0){$("#ActiveTradeDiv").html(""),$("#PendingTradeDiv").html("");for(var o,r=0;r<i.ActiveTrade.length;r++){var l=i.ActiveTrade[r];"COMPLETE"==l.Status?(t+=1,SetActiveTradeDetails(l,o="ActiveTradeDiv")):(a+=1,SetActiveTradeDetails(l,o="PendingTradeDiv"))}$("#Total_Pending").html(""),$("#Total_Active").html(""),$("#Total_Pending").html(a),$("#Total_Active").html(t)}else $("#ActiveTradeDiv").html('<p class="text-center" style="color:#fff">No Active Trade Available.</p>'),$("#PendingTradeDiv").html('<p class="text-center" style="color:#fff">No Active Trade Available.</p>'),$("#Total_Pending").html(""),$("#Total_Active").html(""),$("#Total_Pending").html(a),$("#Total_Active").html(t);$(".TotalActiveTradeProfitOrLoss > h3").text(i.TotalActiveTradeProfitOrLoss),$(".TotalActiveTrade > h3").text(i.TotalActiveTradeCount),i.TotalActiveTradeProfitOrLoss>=0?($(".dvTotalActiveTradeProfitOrLoss").addClass("bg-Purple"),$(".dvTotalActiveTradeProfitOrLoss").removeClass("bg-Danger1")):($(".dvTotalActiveTradeProfitOrLoss").addClass("bg-Danger1"),$(".dvTotalActiveTradeProfitOrLoss").removeClass("bg-Purple")),i.TotalCompletedTradeProfitOrLoss>=0?($(".dvTotalCompletedTradeProfitOrLoss").addClass("bg-Purple"),$(".dvTotalCompletedTradeProfitOrLoss").removeClass("bg-Danger1")):($(".dvTotalCompletedTradeProfitOrLoss").addClass("bg-Danger1"),$(".dvTotalCompletedTradeProfitOrLoss").removeClass("bg-Purple"))}else $("#ActiveTradeDiv").html('<p class="text-center" style="color:#fff">No Active Trade Available.</p>'),$("#PendingTradeDiv").html('<p class="text-center" style="color:#fff">No Active Trade Available.</p>'),$("#Total_Pending").html(""),$("#Total_Active").html(""),$("#Total_Pending").html(a),$("#Total_Active").html(t)}else $("#ActiveTradeDiv").html('<p class="text-center" style="color:#fff">No Active Trade Available.</p>'),$("#PendingTradeDiv").html('<p class="text-center" style="color:#fff">No Active Trade Available.</p>'),$("#Total_Pending").html(""),$("#Total_Active").html(""),$("#Total_Pending").html(a),$("#Total_Active").html(t)}function SetWishlistResult(e){var t=JSON.parse(e);if(null!=t){$("#watchlistDiv").html("");for(var a=0;a<t.objLstWatchList.length;a++)SetWatchTradeDetails(t.objLstWatchList[a]);0==t.objLstWatchList.length&&$("#watchlistDiv").html("")}}function buySellPopUp(e,t,a,i,r,l,o,s,n=1,d=1,c=0,p=0,T=0,v="",u="",b=0,g=""){$(".upperClause :input").removeAttr("disabled"),"EXPO"==$("#CompanyInitial").val()&&($(".TriggerPriceDiv").css("display","none"),$(".rbtnSLDiv").css("display","none"),$("#RememberDiv").css("display","none")),$("#btnProceedBuySell").removeAttr("disabled"),$("#buySellModel .modal-title").css("color","#fff"),$("#buySellModel #Terror").hide(),$("#buySellModel #Quantity-error").hide(),$("#buySellModel #hdnScriptExchange").val(s),$("#buySellModel #hdnScriptLotSize").val(d);var h="";if(1==a?(h="Buy",$("#buySellModel .modal-title").css("background-color","#00a65a"),$("#buySellModel #btnProceedBuySell").css("background-color","#4987ee"),$("#buySellModel #btnProceedBuySell").css("color","#fff"),$("#buySellModel #btnProceedBuySell").text("Buy")):2==a&&(h="Sell",$("#buySellModel .modal-title").css("background-color","#dd4b39"),$("#buySellModel #btnProceedBuySell").css("background-color","#ff4a4a"),$("#buySellModel #btnProceedBuySell").css("color","#fff"),$("#buySellModel #btnProceedBuySell").text("Sell")),$("#dropTradingUnit").html(""),null!=allowedTradingUnit){if(allowedTradingUnit.length>0){var m=allowedTradingUnit.filter(e=>e.ScriptExchange==s),y=[];"FUT"==o||"CE"==o||"PE"==o?"FUT"==o?null==m[0].Future_Trading_Unit_Type||""==m[0].Future_Trading_Unit_Type||void 0==m[0].Future_Trading_Unit_Type?y.push(1):y=m[0].Future_Trading_Unit_Type.split(","):null==m[0].Options_Trading_Unit_Type||""==m[0].Options_Trading_Unit_Type||void 0==m[0].Options_Trading_Unit_Type?y.push(1):y=m[0].Options_Trading_Unit_Type.split(","):null==m[0].Options_Trading_Unit_Type||""==m[0].Options_Trading_Unit_Type||void 0==m[0].Options_Trading_Unit_Type?y.push(1):y=m[0].Equity_Trading_Unit_Type.split(","),$.each(y,function(e,t){"0"==t&&(t="1"),$("#dropTradingUnit").append($("<option></option>").val(parseInt(t)).html("1"==t?"Lot":"Qty"))})}else $("#dropTradingUnit").append($("<option></option>").val(parseInt(1)).html("Lot"))}else $("#dropTradingUnit").append($("<option></option>").val(parseInt(1)).html("Lot"));if($("#lblScriptSymbol").text(i.toString()),$("#lblScriptCode").text(t.toString()),$("#lblCurrentPosition").text(h),$("#WID").val(r),$("#hdnPrice").val(l),$("#hdnTradeID").val(b.toString()),$("#price").val("0"),$("#TriggerPrice").val(c.toString()),$("#txtStopLoss").val(p.toString()),$("#txtTarget").val(T.toString()),$("#Quantity").val(n.toString()),"EQ"!=o?($("#rbtnNrml").val("NRML"),$("#Itype").text("NRML")):($("#rbtnNrml").val("CNC"),$("#Itype").text("CNC")),0==v.length){var f=localStorage.getItem("RememberTargetStoploss");null!=f?(f=JSON.parse(f),$("#cbxRememberTargetStoploss").prop("checked",!0),null!=f.PRODUCT_TYPE&&""!=f.PRODUCT_TYPE&&("MIS"==f.PRODUCT_TYPE?$("input[Name=ProductType]#rbtnIntraday").trigger("click"):$("input[Name=ProductType]#rbtnNrml").trigger("click")),null!=f.PRICE_TYPE&&""!=f.PRICE_TYPE&&("MARKET"==f.PRICE_TYPE?$("input[Name=MarketType]#rbtnMarket").trigger("click"):"Limit"==f.PRICE_TYPE?$("input[Name=MarketType]#rbtnLimit").trigger("click"):"SL"==f.PRICE_TYPE?$("input[Name=MarketType]#rbtnSL").trigger("click"):"SL-M"==f.PRICE_TYPE&&$("input[Name=MarketType]#rbtnSLM").trigger("click")),v=$("input[Name=MarketType]:checked").val()):($("input[Name=MarketType]#rbtnMarket").trigger("click"),$("input[Name=ProductType]#rbtnNrml").trigger("click"))}null!=v&&""!=v&&("MARKET"==v?$("input[Name=MarketType]#rbtnMarket").trigger("click"):"Limit"==v?$("input[Name=MarketType]#rbtnLimit").trigger("click"):"SL"==v?$("input[Name=MarketType]#rbtnSL").trigger("click"):"SL-M"==v&&$("input[Name=MarketType]#rbtnSLM").trigger("click")),null!=u&&""!=u&&("MIS"==u?$("#rbtnIntraday").prop("checked",!0):$("#tgtSLDiv").show()),"COMPLETE"==g&&$(".upperClause :input").attr("disabled","disabled"),$("#buySellModel").modal({backdrop:!1,show:!0}),$(".modal-dialog").draggable({handle:".modal-header"}),$("body").removeClass("modal-open"),$("#hdnSt").val(g),$("#CompanyInitial").val(),"True"==$("#IsTargetStopLossAbsolute").val()&&("Buy"==h.toLowerCase()?($("#txtStopLoss").val(p>0?l-p:0),$("#txtTarget").val(T>0?l+T:0)):($("#txtStopLoss").val(p>0?l+p:0),$("#txtTarget").val(T>0?l-T:0)));var f=localStorage.getItem("RememberTargetStoploss");null!=f&&(f=JSON.parse(f),$("#cbxRememberTargetStoploss").prop("checked",!0),$("#txtTarget").val(f.TGT),$("#txtStopLoss").val(f.SL))}function ProceedBuySell(){if(!0==$("#cbxRememberTargetStoploss").prop("checked")){var e={TGT:$("#txtTarget").val(),SL:$("#txtStopLoss").val()};localStorage.setItem("RememberTargetStoploss",JSON.stringify(e))}else localStorage.removeItem("RememberTargetStoploss");var t=$("#lblScriptCode").text(),a=$("#lblCurrentPosition").text();intWID=$("#WID").val();var i=$("#txtTarget").val(),r=$("#txtStopLoss").val(),l=$("#Quantity").val();$("#buySellModel #hdnScriptExchange").val(),$("#buySellModel #hdnScriptLotSize").val();var o=$("#price").val(),s=$("#TriggerPrice").val(),n=$("#hdnTradeID").val(),d=$("input[Name=ProductType]:checked").val(),c=$("input[Name=MarketType]:checked").val();if(null==t||""==t||null==a||""==a){toastr.error("Please enter correct details");return}if("SL"==c||"SL-M"==c){var p=parseFloat(o),T=parseFloat(s),v=$("#buySellModel #hdnPrice").val(),u=parseFloat(v),b=!1,g="";if("SL"==c&&("Sell"==a&&"SL"==c&&p>T?(b=!0,g="Trigger price connot be less than order price"):"Buy"==a&&"SL"==c&&p<T&&(b=!0,g="Trigger price Cannot be higher than order price")),"Sell"==a&&T>u?(b=!0,g="Trigger price Cannot be higher than last price"):"Buy"==a&&T<u&&(b=!0,g="Trigger price connot be less than last price"),b){$("#buySellModel #Terror").text(g),$("#buySellModel #Terror").show(),$("#btnProceedBuySell").removeAttr("disabled");return}if(p>0?Lastprice=p:p=Lastprice,$("#CompanyInitial").val(),"True"==$("#IsTargetStopLossAbsolute").val()){var g="";if("Buy"==a?(i>0&&i<p&&(g="Target should be greater than Order price"),r>0&&r>p&&(g="StopLoss should be less than Order price")):(i>0&&i>p&&(g="Target should be less than Order price"),r>0&&r<p&&(g="StopLoss  should be greater than Order price")),""!=g){toastr.error(g),$("#btnProceedBuySell").removeAttr("disabled");return}}}var h=$("#hdnSt").val(),m=$("#dropTradingUnit").val();t>0&&intWID>0&&""!=l&&"0"!=l&&$.ajax({url:"/Trade/ProceedBuySell",type:"POST",data:{intWID:intWID,ScriptCode:t,CurrentPosition:a,allUsers:!1,target:i,stopLoss:r,Quantity:l,price:o,TriggerPrice:s,ProductType:d,MarketType:c,TradeID:n,Status:h,iscbxAutoBinanceSlTrailEnabled:0,TRADING_UNIT:m},dataType:"json",async:!0,success:function(e){var t=JSON.parse(e);return t.IsError?(HidePopUp(),$("#errorModal .modal-body").html('<p class="text-danger">'+t.TypeName+"</p>"),$("#errorModal").modal("show"),!1):("0"!=n?($("#errorModal .modal-body").html('<p class="text-success">Order Updated successfully</p>'),$("#errorModal").modal("show")):($("#errorModal .modal-body").html('<p class="text-success">Order Placed successfully</p>'),$("#errorModal").modal("show")),!1)}}),HidePopUp(),$("#btnProceedBuySell").removeAttr("disabled")}function HidePopUp(){$("#buySellModel").modal("hide")}function SquareOff(e,t,a,i,r){$(sqModal).find(".sqMsg").text(""),$(sqModal).find("input[Name=sqQty]").val(i),$(sqModal).find("input[Name=hdQty]").val(i),$(sqModal).find("input[Name=sqActiveTradeID]").val(e),$(sqModal).find("input[Name=sqStatus]").val(a),$(sqModal).find("input[Name=sqParam]").val(t),r?$(sqModal).modal("show"):newconfirmMobile("square off?",function(){var e=$("body").find(".cresp").html();$("body").find(".cresp").remove(),"Yes"==e&&ProceedSqOf()})}function ProceedSqOf(){$(sqModal).find(".sqMsg").text("");var e=$(sqModal).find("input[Name=sqQty]").val(),t=$(sqModal).find("input[Name=hdQty]").val(),a=0;if(""==e||"0"==e||(a=parseInt(e,10))>parseInt(t,10))return $("#btnProceedSquareOff").removeAttr("disabled"),$(sqModal).find(".sqMsg").text("Invalid Qty"),!1;var i=$(sqModal).find("input[Name=sqActiveTradeID]").val(),r=$(sqModal).find("input[Name=sqStatus]").val(),l=$(sqModal).find("input[Name=sqParam]").val();$.ajax({url:"/Trade/ManageTradeSquareOff",type:"POST",data:{ID:i,actionParam:l,Status:r,Qty:a,isSupAdmin:1},dataType:"json",traditional:!0,success:function(e){var t=JSON.parse(e);return 1==t.exceptionDTO.id?toastr.success(t.exceptionDTO.Msg):0==t.exceptionDTO.id?toastr.success(t.exceptionDTO.Msg):2==t.exceptionDTO.id&&toastr.success(t.exceptionDTO.Msg),!1}}),$("#btnProceedSquareOff").removeAttr("disabled"),$(sqModal).modal("hide")}function CallSync(e){newconfirmMobile("sync order?",function(){var t=$("body").find(".cresp").html();$("body").find(".cresp").remove(),"Yes"==t&&$.ajax({url:"/Trade/CallSync",type:"POST",data:{ID:e},dataType:"json",traditional:!0,success:function(e){return JSON.parse(e),$("#errorModal .modal-body").html('<p class="text-success">Order Sync request sent successfully</p>'),$("#errorModal").modal("show"),!1}})})}function SetMarketDepthForRefresh(e){$.ajax({url:"/Trade/_MarketDepthMobile",type:"POST",data:{ScriptCode:e},async:!0,success:function(e){return $("#marketDepthDiv").html(e),!0}})}function HideDepthModal(){$("#MarketDepthModal").modal("hide")}function HideCompletedTradeModal(){$("#CompletedTradeModal").modal("hide")}function btnLoginToTradeUsingModal(){var e=$("#btnKiteLogin").attr("href");return $.ajax({url:e,type:"GET",data:{},dataType:"json",traditional:!0,success:function(e){var t=e;if(""==t)return $("#txtScript").val(""),ShowAlertMessage(1,"Login Sccuessfully."),!1;window.location.href=t}}),!1}function SetWatchlistPagination(){$("#WatchlistPagination").twbsPagination({totalPages:_WatchlistTotalPageNo,visiblePages:2,onPageClick:function(e,t){_isWatchlistCallBack?(_WatchlistCurrentPageNo=t,LastPriceDictionary=[],BtnIds=[],_WatchlistCurrentTabIndex=0):_isWatchlistCallBack=!0}})}function WatchlistPaginationDestroy(){$("#WatchlistPagination").empty(),$("#WatchlistPagination").removeData("twbs-pagination"),$("#WatchlistPagination").unbind("page")}function SetCompletedPagination(){$("#CompletedPagination").twbsPagination({totalPages:_CompletedTotalPageNo,visiblePages:2,onPageClick:function(e,t){_CompletedCallBack?(_CompletedCurrentPageNo=t,SetCompletedTradeModalData()):_CompletedCallBack=!0}})}function CompletedPaginationDestroy(){$("#CompletedPagination").empty(),$("#CompletedPagination").removeData("twbs-pagination"),$("#CompletedPagination").unbind("page")}function SetActiveTradePagination(){$("#ActiveTradePagination").twbsPagination({totalPages:_ActiveTotalPageNo,visiblePages:2,onPageClick:function(e,t){_ActiveCallBack?_ActiveCurrentPageNo=t:_ActiveCallBack=!0}})}function ActiveTradePaginationDestroy(){$("#ActiveTradePagination").empty(),$("#ActiveTradePagination").removeData("twbs-pagination"),$("#ActiveTradePagination").unbind("page")}function GetCompletedData(){if("--Select--"!=$("#UserIds option:selected").text())var e=$("#UserIds").val();if((1==LevelLoginUser||2==LevelLoginUser)&&"--Select--"!=$("#AdminIds option:selected").text())var e=$("#AdminIds").val();if((1==LevelLoginUser||2==LevelLoginUser||3==LevelLoginUser)&&"--Select--"!=$("#BrokerIds option:selected").text())var e=$("#BrokerIds").val();if(4==LevelLoginUser&&"--Select--"!=$("#UserIds option:selected").text())var e=$("#UserIds").val();""!=e&&null!=e?SetCompletedTradeModalData():toastr.error("Please Select User From Dropdown")}function SetCompletedTradeModalData(){try{var e=$("#watchlistHiddenId").val(),t=$("#cboScriptExchange option:selected").val();if("--Select--"!=$("#UserIds option:selected").text())var a=$("#UserIds").val(),i="0";if((1==LevelLoginUser||2==LevelLoginUser)&&"--Select--"!=$("#AdminIds option:selected").text())var a=$("#AdminIds").val(),i="1";if((1==LevelLoginUser||2==LevelLoginUser||3==LevelLoginUser)&&"--Select--"!=$("#BrokerIds option:selected").text())var a=$("#BrokerIds").val(),i="1";if(4==LevelLoginUser&&"--Select--"!=$("#UserIds option:selected").text()){$("#UserIds").val();var i="1"}var r="";r=!0==$("#rdAll").prop("checked")?{tradetype:0,WID:e,scriptExchangeType:t,CompletedListPage:_CompletedCurrentPageNo,UserID:a,IsAdminOrNot:i}:!0==$("#rdLive").prop("checked")?{tradetype:1,WID:e,scriptExchangeType:t,CompletedListPage:_CompletedCurrentPageNo,UserID:a,IsAdminOrNot:i}:{tradetype:2,WID:e,scriptExchangeType:t,CompletedListPage:_CompletedCurrentPageNo,UserID:a,IsAdminOrNot:i},$.ajax({url:"/Trade/SetCompletedTradeDataForManageTransaction",type:"GET",data:r,dataType:"json",async:!0,success:function(e){var t=JSON.parse(e);if(null!=t&&($("#CompletedTradeDiv").html(""),null!=t.CompletedTrade&&t.CompletedTrade.length>0))for(var a=0;a<t.CompletedTrade.length;a++){var i=t.CompletedTrade[a];SetCompletedTradeTableDetails(i),BindClick()}}})}catch(l){toastr.error("Error On SetTradeData.")}}function SetCompletedTradeTableDetails(e){var t,a="";parseFloat(e.Profitorloss)>=0?a='<font style="color:rgb(91, 233, 91);font-weight:bold;">'+e.Profitorloss+"</font>":0>parseFloat(e.Profitorloss)&&(a='<font style="color:#ff4a4a;font-weight:bold;">'+e.Profitorloss+"</font>"),t=1==e.TRADING_UNIT_TYPE?e.Qty/e.ScriptLotSize:e.ScriptLotSize>10&&"MCX"==e.ScriptExchange&&("EXPO"==e.COMPANY_INITIAL&&51==e.TENANT_ID||"ASR"==e.COMPANY_INITIAL&&57==e.TENANT_ID||"RVERMA"==e.COMPANY_INITIAL)?e.Qty/(e.ScriptLotSize/10):e.Qty;var i="Qty"==e.TRADING_UNIT.toLowerCase()?"U":"";"FOREX"==e.ScriptExchange&&"RT"==$("#Companyinitials").val()&&(e.Entryprice=e.Entryprice.toFixed(5),e.Exitprice=e.Exitprice.toFixed(5));var r='<div class="row completedTradeRow" data-id='+e.Completedtradeid+" data-ScriptName="+e.TradeSymbol+'><div class="col-12" ><div class="row-New-Theme watchlistRow"><div class="card-body" style="padding: 0px 0px 0px 5px;">   <div class="row"><div class="col-7"> <p class="watchlist-p" style="font-size: 14px; margin-bottom: 5px;margin: 0px 0px 0px 30px;">'+e.TradeSymbol+'</p></div><div class="col-5">     <div class="row" style="margin-top:0px;">          <div class="col-5">               <label class="watchlist-p" style="font-size: 12px"margin: 0px 0px 0px 30px;> Qty: '+t+i+'</label>          </div>              </div>           </div><div class="col-5">  <p class="watchlist-p" style="font-size: 13px;  margin-bottom: 7px;margin-top:7px;margin: 0px 0px 0px 30px;">ENTRY : '+e.Entryprice+' </p></div><div class="col-5">  <p class="watchlist-p" style="font-size: 13px;  margin-bottom: 7px;margin-top:7px;margin: 0px 0px 0px 30px;">EXIT : '+e.Exitprice+' </p></div><div class="col-12" >  <p class="watchlist-p" style="font-size: 13px;  margin-bottom: 7px;margin-top:7px;margin: 0px 0px 0px 30px;"> P&L : '+a+" | CP : "+e.CurrentPosition+'</p>  <p class="watchlist-p" style="font-size: 13px;  margin-bottom: 7px;margin-top:7px;margin: 0px 0px 0px 30px;">ENTRY TIME :  '+e.Entrydate+" "+e.Entrytime+'  </p>  <p class="watchlist-p" style="font-size: 13px;  margin-bottom: 7px;margin-top:7px;margin: 0px 0px 0px 30px;">EXIT TIME :  '+e.ExitDate+" "+e.Exittime+"  </p></div>        </div>     </div>  </div></div ></div >";$("#CompletedTradeDiv").append(r)}function BindClick(){}function AddQty(e,t,a){$(addQtyModal).find(".sqMsg").text(""),$(addQtyModal).find("#btnProceedAddQty").removeAttr("disabled"),$(addQtyModal).find("input[Name=sqActiveTradeID]").val(e),$(addQtyModal).find("input[Name=sqStatus]").val(a),$(addQtyModal).find("input[Name=sqParam]").val(t),$(addQtyModal).modal("show")}function ProceedAddQty(){$(addQtyModal).find(".sqMsg").text("");var e=$(addQtyModal).find("input[Name=sqQty]").val(),t=0;if(""==e||"0"==e)return $(addQtyModal).find("#btnProceedAddQty").removeAttr("disabled"),$(addQtyModal).find(".sqMsg").text("Invalid Qty"),!1;t=parseInt(e,10);var a=$(addQtyModal).find("input[Name=sqActiveTradeID]").val(),i=$(addQtyModal).find("input[Name=sqStatus]").val(),r=$(addQtyModal).find("input[Name=sqParam]").val();$.ajax({url:"/Trade/AddQtyToActiveTrade",type:"POST",data:{ID:a,actionParam:r,Status:i,Qty:t},dataType:"json",traditional:!0,success:function(e){var t=JSON.parse(e);return 1==t.exceptionDTO.id?toastr.success(t.exceptionDTO.Msg):0==t.exceptionDTO.id?toastr.success(t.exceptionDTO.Msg):2==t.exceptionDTO.id&&toastr.success(t.exceptionDTO.Msg),!1}}),$(addQtyModal).find("#btnProceedAddQty").removeAttr("disabled"),$(addQtyModal).modal("hide")}function getTradingUnit(e){$.ajax({url:"/Trade/GetTradingUnitAccess?UserID="+e,type:"GET",dataType:"json",success:function(e){null!=e&&""!=e&&(allowedTradingUnit=JSON.parse(e))}})}function SqrOffAllForManageTransaction(){newconfirmMobile("square off All?",function(){var e=$("body").find(".cresp").html();if($("body").find(".cresp").remove(),"Yes"==e){if("--Select--"!=$("#UserIds option:selected").text())var t=$("#UserIds").val(),a=$("#UserIds option:selected").text();if((1==LevelLoginUser||2==LevelLoginUser)&&"--Select--"!=$("#AdminIds option:selected").text())var t=$("#AdminIds").val(),a=$("#AdminIds option:selected").text();if((1==LevelLoginUser||2==LevelLoginUser||3==LevelLoginUser)&&"--Select--"!=$("#BrokerIds option:selected").text())var t=$("#BrokerIds").val(),a=$("#BrokerIds option:selected").text();$.ajax({url:"/Trade/SqrOffAllForManageTransaction",type:"Get",data:{UserID:t,Username:a},dataType:"json",traditional:!0,success:function(e){var t=JSON.parse(e);1==t.exceptionDTO.id?toastr.success(t.exceptionDTO.Msg):0==t.exceptionDTO.id?toastr.error(t.exceptionDTO.Msg):2==t.exceptionDTO.id&&toastr.error(t.exceptionDTO.Msg)}})}})}function DeleteRejectedTrade(e){newconfirmMobile("delete?",function(){var t=$("body").find(".cresp").html();$("body").find(".cresp").remove(),"Yes"==t&&$.ajax({url:"/Trade/DeleteRejectedTrade?ID="+e,type:"GET",async:!0,success:function(e){null!=e&&toastr.success(e),SetTradeDataForRefresh()}})})}function DeleteActiveTrade(e,t){newconfirmMobile("Delete This Record",function(){var a=$("body").find(".cresp").html();$("body").find(".cresp").remove(),"Yes"==a&&$.ajax({url:"/Trade/DeleteActiveTrade?ID="+e+"&UserID="+t,type:"GET",async:!0,success:function(e){null!=e&&toastr.success(e)}})})}$("#searchText").on("keyup",function(){SetTradeDataForRefresh()}),$("#btnexport").click(function(){var e=$('#tblCompletedTradeList_filter input[type="search"]').val();window.location='/Trade/download?search="'+e+'"'}),$("#btnAddWatchList").on("click",function(){var e=$("#watchList option:selected").val();null==e||""==e?window.location.href="/WatchList/AddWatchList?ID=0":window.location.href="/WatchList/AddWatchList?ID="+e}),$("#watchList").on("change",function(){var e=this.value;if($("#watchlistHiddenId").val(e),null!=e&&""!=e)try{var t="";t=!0==$("#rdAll").prop("checked")?{tradetype:0}:!0==$("#rdLive").prop("checked")?{tradetype:1}:{tradetype:2},$.ajax({url:"/Trade/GetWatchListTradeByWid",type:"GET",data:{WID:e},dataType:"json",success:function(e){SetWishlistResult(e)}})}catch(a){toastr.error("Error On SetTradeData.")}}),$("#cboScriptExchange").on("change",function(){try{SetTradeDataForRefresh()}catch(e){toastr.error("Error On SetTradeData.")}}),$("#SqrOffAllBtn").on("click",function(){newconfirmMobile("sqr-Off All Trades ?",function(){var e=$("body").find(".cresp").html();$("body").find(".cresp").remove(),"Yes"==e&&(window.location.href="/Trade/SqrOffAll")})}),$("#UserIds").on("change",function(){""!=$("#UserIds").val()?($("#AdminIds").val(null).trigger("change"),$("#BrokerIds").val(null).trigger("change"),$("#SqrOffBtn").show(),$("#btnAddWatchList").show(),LastPriceDictionary=[],BtnIds=[],getTradingUnit($("#UserIds").val()),_WatchlistCurrentTabIndex=0,clearInterval(myInterval),myInterval=setInterval(function(){SetTradeDataForRefresh()},1e3)):($("#SqrOffBtn").hide(),$("#btnAddWatchList").hide(),LastPriceDictionary=[],BtnIds=[],_WatchlistCurrentTabIndex=0)}),$("#AdminIds").on("change",function(){""!=$("#AdminIds").val()?($("#BrokerIds").val(null).trigger("change"),$("#UserIds").val(null).trigger("change"),$("#SqrOffBtn").show(),$("#btnAddWatchList").show(),LastPriceDictionary=[],BtnIds=[],getTradingUnit($("#AdminIds").val()),_WatchlistCurrentTabIndex=0,clearInterval(myInterval),myInterval=setInterval(function(){SetTradeDataForRefresh()},1e3)):($("#SqrOffBtn").hide(),$("#btnAddWatchList").hide(),LastPriceDictionary=[],BtnIds=[],_WatchlistCurrentTabIndex=0)}),$("#BrokerIds").on("change",function(){""!=$("#BrokerIds").val()?($("#AdminIds").val(null).trigger("change"),$("#UserIds").val(null).trigger("change"),$("#SqrOffBtn").show(),$("#btnAddWatchList").show(),LastPriceDictionary=[],BtnIds=[],_WatchlistCurrentTabIndex=0,getTradingUnit($("#BrokerIds").val()),clearInterval(myInterval),myInterval=setInterval(function(){SetTradeDataForRefresh()},1e3)):($("#SqrOffBtn").hide(),$("#btnAddWatchList").hide(),LastPriceDictionary=[],BtnIds=[],_WatchlistCurrentTabIndex=0)});